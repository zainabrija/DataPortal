{% extends "base.html" %}

{% block title %}Admin Dashboard - PBS Data Portal{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="mb-4 fw-bold text-primary">Admin Dashboard</h1>
    
    <div class="table-container">
        <table class="table table-hover mb-0">
            <thead class="table-primary">
                <tr>
                    <th>Dataset Name</th>
                    <th>User</th>
                    <th>Submission Date</th>
                    <th>Status</th>
                    <th>Priority</th>
                    <th>Deadline</th>
                    <th>Payment Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for request in requests %}
                <tr>
                    <td>{{ request.dataset_name }}</td>
                    <td>{{ request.user.name }}</td>
                    <td>{{ request.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                        <select class="form-select form-select-sm status-select" data-request-id="{{ request.id }}" data-field="status">
                            <option value="Pending" {% if request.status == 'Pending' %}selected{% endif %}>Pending</option>
                            <option value="In Progress" {% if request.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                            <option value="Completed" {% if request.status == 'Completed' %}selected{% endif %}>Completed</option>
                            <option value="Cancelled" {% if request.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                        </select>
                    </td>
                    <td>
                        <span class="status-badge priority-{{ request.priority.lower() }}">
                            {{ request.priority }}
                        </span>
                    </td>
                    <td>
                        {% if request.deadline %}
                            {{ request.deadline.strftime('%Y-%m-%d') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <select class="form-select form-select-sm payment-select" data-request-id="{{ request.id }}" data-field="payment_status">
                            <option value="Unpaid" {% if request.payment_status == 'Unpaid' %}selected{% endif %}>Unpaid</option>
                            <option value="Paid" {% if request.payment_status == 'Paid' %}selected{% endif %}>Paid</option>
                            <option value="Pending" {% if request.payment_status == 'Pending' %}selected{% endif %}>Pending</option>
                        </select>
                    </td>
                    <td>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#viewModal{{ request.id }}">
                                View
                            </button>
                            <button type="button" class="btn btn-outline-warning btn-sm" data-bs-toggle="modal" data-bs-target="#editModal{{ request.id }}">
                                Update
                            </button>
                            <button type="button" class="btn btn-outline-success btn-sm" onclick="exportRequest({{ request.id }})">
                                Export
                            </button>
                        </div>
                    </td>
                </tr>
                
                <!-- View Modal -->
                <div class="modal fade" id="viewModal{{ request.id }}" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Request Details</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Request Information</h6>
                                        <p><strong>Dataset Name:</strong> {{ request.dataset_name }}</p>
                                        <p><strong>Purpose:</strong> {{ request.purpose }}</p>
                                        <p><strong>Data Type:</strong> {{ request.data_type }}</p>
                                        <p><strong>Data Format:</strong> {{ request.data_format }}</p>
                                        <p><strong>Urgency Level:</strong> {{ request.urgency_level }}</p>
                                        <p><strong>Status:</strong> {{ request.status }}</p>
                                        <p><strong>Priority:</strong> {{ request.priority }}</p>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>User Information</h6>
                                        <p><strong>Name:</strong> {{ request.user.name }}</p>
                                        <p><strong>Email:</strong> {{ request.user.email }}</p>
                                        <p><strong>Phone:</strong> {{ request.user.phone }}</p>
                                        <p><strong>Department:</strong> {{ request.user.department }}</p>
                                        <p><strong>City:</strong> {{ request.user.city }}</p>
                                        <p><strong>Province:</strong> {{ request.user.province }}</p>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h6>Timeline</h6>
                                        <p><strong>Requested Date:</strong> {{ request.requested_date.strftime('%Y-%m-%d') }}</p>
                                        <p><strong>Submission Date:</strong> {{ request.created_at.strftime('%Y-%m-%d') }}</p>
                                        <p><strong>Deadline:</strong> 
                                            {% if request.deadline %}
                                                {{ request.deadline.strftime('%Y-%m-%d') }}
                                            {% else %}
                                                Not specified
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h6>Description</h6>
                                        <p>{{ request.description }}</p>
                                        {% if request.comments %}
                                            <h6>Comments</h6>
                                            <p>{{ request.comments }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Edit Modal -->
                <div class="modal fade" id="editModal{{ request.id }}" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Update Request</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <form method="POST" action="{{ url_for('admin_update_request', request_id=request.id) }}">
                                <div class="modal-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Status</label>
                                                <select class="form-select" name="status" required>
                                                    <option value="Pending" {% if request.status == 'Pending' %}selected{% endif %}>Pending</option>
                                                    <option value="In Progress" {% if request.status == 'In Progress' %}selected{% endif %}>In Progress</option>
                                                    <option value="Completed" {% if request.status == 'Completed' %}selected{% endif %}>Completed</option>
                                                    <option value="Cancelled" {% if request.status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Payment Status</label>
                                                <select class="form-select" name="payment_status" required>
                                                    <option value="Unpaid" {% if request.payment_status == 'Unpaid' %}selected{% endif %}>Unpaid</option>
                                                    <option value="Paid" {% if request.payment_status == 'Paid' %}selected{% endif %}>Paid</option>
                                                    <option value="Pending" {% if request.payment_status == 'Pending' %}selected{% endif %}>Pending</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Admin Notes</label>
                                        <textarea class="form-control" name="admin_notes" rows="3" placeholder="Add any internal notes..."></textarea>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Update Request</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if not requests %}
    <div class="text-center py-5">
        <h4 class="text-muted">No data requests found</h4>
        <p class="text-muted">There are no pending data requests.</p>
    </div>
    {% endif %}
    
    <div class="text-center mt-4">
        <a href="{{ url_for('home') }}" class="btn btn-primary">Back to Homepage</a>
    </div>
</div>

<script>
// Handle status and payment status changes
document.querySelectorAll('.status-select, .payment-select').forEach(select => {
    select.addEventListener('change', function() {
        const requestId = this.dataset.requestId;
        const field = this.dataset.field;
        const value = this.value;
        
        fetch(`/admin/update-request/${requestId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `${field}=${value}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
                alert.style.top = '20px';
                alert.style.right = '20px';
                alert.style.zIndex = '9999';
                alert.innerHTML = `
                    <strong>Success!</strong> Request updated successfully.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(alert);
                
                // Remove alert after 3 seconds
                setTimeout(() => {
                    alert.remove();
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating request. Please try again.');
        });
    });
});

function exportRequest(requestId) {
    // Here you would implement the export functionality
    alert('Export functionality would be implemented here for request ID: ' + requestId);
}
</script>
{% endblock %} 